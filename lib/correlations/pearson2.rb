# Input: 2 matrices
#        arrays1: each row corresponds to a dataset on the left side of the Explore map
#        arrays2: each row corresponds to a dataset on the top side of the Explore map
# Output: 1 matrix
#         where each entry[i][j] is the correlation of the ith dataset on the left side
#           with the jth dataset on the top side

# the following ruby_pearson was altered and copied from http://blog.chrislowis.co.uk/2008/11/24/ruby-gsl-pearson.html
def pearson2(arrays1, arrays2)

  # the following 3 lines were altered and copied from http://stackoverflow.com/questions/5372701/how-to-declare-an-empty-2-dimensional-array-in-ruby
  width = arrays1.length
  height = arrays2.length
  ans = Array.new(width){Array.new(height, 0.0)}
  # -- end copy --

  arrays1.each_with_index{|array1, i|
    
    arrays2.each_with_index{|array2, j|

      # sift out empty values
      x = [0.0]
      y = [0.0]
      numSkipped1 = 0
      numSkipped2 = 0
      index = 0
      array1.each_with_index{|point, k|
        if point.nil?
          #puts "  skipped x[#{i}][#{k}]"
          numSkipped1 +=1
        elsif array2[k].nil?
          #puts "  skipped y[#{j}][#{k}]"
          numSkipped2 +=1
        else
          x[index] = point
          y[index] = array2[k]
          #puts "#{x[index]}  #{y[index]}"
          index +=1
        end
      }
      #puts " x[#{i}]= #{x}"
      #puts " y[#{j}]= #{y}"

      if numSkipped1 == array1.length
        ans[i][j] = 0.0
      elsif numSkipped2 == array2.length
        ans[i][j] = 0.0
      else
        # Correlation pre-calculations
        n=x.length

        sumx=x.inject(0) {|r,m| r + m}
        sumy=y.inject(0) {|r,m| r + m}

        sumxSq=x.inject(0) {|r,m| r + m**2}
        sumySq=y.inject(0) {|r,m| r + m**2}

        prods=[]; x.each_with_index{|this_x,m| prods << this_x*y[m]}
        pSum=prods.inject(0){|r,m| r + m}

        # Calculate Pearson score
        num=pSum-(sumx*sumy/n)
        den=((sumxSq-(sumx**2)/n)*(sumySq-(sumy**2)/n))**0.5

        r=num/den
        ans[i][j] = r.real

        if ans[i][j].nan?
          ans[i][j] = rand() *2 -1
        end
        
      end
    }
  }
  return ans
end

def test(a,b,x,y)
  puts "corr(#{a},#{b})= #{pearson2(x,y).inspect}"
end

if __FILE__ == $0

  tests = 0
  if tests == 1
    a1=[[1,2,3,4,5,6,7,8],[1,2,3,4,5,6,7,8],[1,2,3,4,5,6,7,8],[1,2,3,4,5,6,7,8]]
    a2=[[2,3,4,5,6,7,8,9],[2,3,4,5,6,7,8,9],[2,3,4,5,6,7,8,9],[2,3,4,5,6,7,8,9]]

    #test(1,2,a1,a2)

    a3=[[nil,nil,3,4,5,6,7,8],[1,2,nil,nil,nil,nil,7,8],[1,2,3,4,5,6,nil,nil],[nil,nil,nil,nil,nil,nil,nil,nil]]
    a4=[[1,2,3,4,5,6,7,8]]

    #test(4,3,a4,a3) # empty values

    a5=[[2,2,3,3,4,3,4,5],[8,7,6,5,4,3,2,1]]

    #test(4,5,a4,a5) # not totally correlated, inversely correlated

    a6=[[2,2,3,3,4,4],[1,2,3,3,5,4,6,5,7]]

    #test(4,6,a4,a6) # different length

    a7 = [[1060000000000.0, 970000000000.0, 900000000000.0, 790000000000.0, 780000000000.0, 860000000000.0, 940000000000.0, 1060000000000.0, 1110000000000.0, 1080000000000.0, 1160000000000.0, 1270000000000.0, 1490000000000.0, 1770000000000.0, 2069999999999.0, 2240000000000.0, 2220000000000.0, 1960000000000.0, 1960000000000.0, 2040000000000.0, 2000000000000.0, 2270000000000.0, 2400000000000.0, 2530000000000.0, 2540000000000.0, 2610000000000.0, 2780000000000.0, 2840000000000.0, 2850000000000.0, 2920000000000.0, 3060000000000.0, 3080000000000.0, 3280000000000.0, 3420000000000.0, 3600000000000.0, 3780000000000.0, 4099999999999.0, 4290000000000.0, 4400000000000.0, 4620000000000.0, 4720000000000.0, 4710000000000.0, 4910000000000.0, 5250000000000.0, 5460000000000.0, 5360000000000.0, 5490000000000.0, 5730000000000.0, 6020000000000.0, 6420000000000.0, 6500000000000.0, 6500000000000.0, 6590000000000.0, 6490000000000.0, 7000000000000.0, 7400000000000.0, 7710000000000.0, 7940000000000.0, 8289999999999.0, 8609999999999.0, 8850000000000.0, 8910000000000.0, 9020000000000.0, 9410000000000.0, 9650000000000.0, 10050000000000.0, 10280000000000.0, 10740000000000.0, 11210000000000.0, 11770000000000.0, 12320000000000.0, 12680000000000.0, 12710000000000.0, 12960000000000.0, 13530000000000.0, 13950000000000.0, 14370000000000.0, 14720000000000.0, 14990000000000.0, 14580000000000.0, 14540000000000.0, 14940000000000.0, 15190000000000.0, 15430000000000.0, 15920000000000.0, 16160000000000.0], [24.9, 25.2, 23.3, 20.1, 22.7, 22.5, 17.9, 19.2, 20.0, 20.7, 14.4, 13.2, 17.8, 21.1, 17.5, 14.6, 18.7, 20.2, 18.8, 12.5, 14.6, 14.0, 17.5, 17.1, 13.3, 10.5, 11.9, 14.9, 10.0, 8.5], [23.0, 26.7, 28.0, 22.8, 19.9, 21.1, 19.4, 15.8, 22.3, 15.8, 18.9, 15.9, 14.8, 13.9, 14.4, 17.1, 16.3, 16.4, 15.8, 15.4, 18.2, 11.1, 9.1, 10.7, 10.6, 15.8, 9.6, 9.3, 15.5, 11.7], [26.9, 28.2, 25.6, 21.4, 25.6, 19.8, 21.1, 22.7, 17.8, 18.2, 16.6, 18.7, 20.8, 17.4, 20.6, 19.7, 13.9, 12.7, 12.8, 18.4, 11.1, 17.0, 13.3, 13.8, 16.5, 13.1, 14.7, 12.0, 12.7, 15.1], [85.9, 84.7, 85.7, 84.6, 85.5, 86.1, nil, nil, 83.0, 82.8, 82.9, 83.0, 83.4, 82.9, 83.0, 82.1], [0.076652, 0.069113, 0.060317, 0.079166, 0.065343, 0.05906, 0.050264, 0.06283, 0.071626, 0.082935, 0.079166, 0.075471, 0.198128, 1.08839, 0.485686, 0.212806, 0.501951, 0.197131, nil, 0.123237], [0.03545, 0.03364, 0.03909, 0.05409, 0.06, 0.03182, 0.06591, 0.06864, 1.92045, 0.0985, 0.1175, 0.125, 0.115, 0.113, 0.1, 0.09, 0.114, 0.118, 0.103, 0.105, 0.107, 0.114, 0.113, 0.107, 0.108, 0.28], [4.8208333333333, 4.5, 4.5, 4.5, 4.5, 4.535, 5.625, 5.6333333333333, 6.3125, 7.9516666666667, 7.91, 5.7233333333333, 5.2483333333333, 8.0216666666667, 10.798333333333, 7.8625, 6.84, 6.8241666666667, 9.0566666666667, 12.665833333333, 15.265833333333, 18.87, 14.860833333333, 10.794166666667, 12.0425, 9.9333333333333, 8.3325, 8.2033333333333, 9.315, 10.873333333333, 10.009166666667, 8.4633333333333, 6.2516666666667, 6.0, 7.1383333333333, 8.8291666666667, 8.2708333333333, 8.4416666666667, 8.3541666666667, 7.9941666666667, 9.2333333333333, 6.9216666666667, 4.675, 4.1225, 4.34, 6.1891666666667, 7.9575, 8.05, 5.0875, 3.25, 3.25, 3.25, 3.25, 3.25]]
    a8 = [[180670000.0, 183690000.0, 186540000.0, 189240000.0, 191890000.0, 194300000.0, 196560000.0, 198710000.0, 200710000.0, 202680000.0, 205050000.0, 207660000.0, 209900000.0, 211910000.0, 213850000.0, 215970000.0, 218040000.0, 220240000.0, 222580000.0, 225060000.0, 227220000.0, 229470000.0, 231660000.0, 233790000.0, 235820000.0, 237920000.0, 240130000.0, 242290000.0, 244500000.0, 246820000.0, 249620000.0, 252980000.0, 256510000.0, 259920000.0, 263130000.0, 266279999.0, 269390000.0, 272650000.0, 275850000.0, 279040000.0, 282160000.0, 284970000.0, 287630000.0, 290110000.0, 292810000.0, 295520000.0, 298380000.0, 301230000.0, 304090000.0, 306770000.0, 309330000.0, 311590000.0, 313910000.0, 316160000.0], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, -11.375, 8.9, -65.875, -96.025, -63.3, -76.1, -98.15, -50.225, -20.4, 4.425, -42.8, -75.375, -140.625, -103.4, -20.325, 21.675, 91.7, 200.325, 302.0, 322.6, 397.9, 155.705, -214.143, -352.056, -327.619, -187.953, -53.232, -158.688, -730.209, -1669.565, -1381.167, -1182.383, -1022.657, -607.236], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 718.708, 799.421, 964.618, 1169.27, 1348.95, 1576.86, 1824.02, 2040.74, 2269.8, 2447.21, 2664.53, 2959.52, 3346.96, 3689.85, 3878.79, 4018.99, 4098.05, 4095.44, 3978.42, 3786.63, 3543.94, 3587.188, 3990.443, 4571.797, 5755.2, 6057.852, 6202.144, 6440.884, 7425.251, 8955.682, 10424.989, 11802.752, 12840.457, 13474.773], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 882.6, 1011.1, 1042.3, 1108.9, 1229.1, 1338.7, 1423.7, 1548.3, 1658.7, 1799.3, 1907.9, 2010.6, 2071.0, 2194.4, 2359.4, 2496.1, 2676.6, 2868.9, 3059.7, 3249.4, 3506.3, 3412.072, 3269.226, 3355.171, 3596.227, 4013.141, 4371.081, 4584.355, 4441.666, 4095.081, 4304.189, 4512.451, 4718.314, 5173.936], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 946.7, 1072.0, 1191.3, 1299.5, 1409.0, 1541.9, 1648.9, 1741.4, 1832.6, 1968.5, 2143.2, 2298.3, 2431.6, 2520.6, 2613.2, 2732.7, 2848.4, 2935.4, 3026.0, 3177.6, 3353.5, 3505.57, 3718.912, 3936.06, 4158.897, 4464.684, 4699.782, 5047.392, 5477.064, 6044.522, 5994.169, 6055.624, 6106.51, 6139.217], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 22.031, 23.21, 21.762, 19.776, 21.892, 20.336, 18.906, 19.551, 20.564, 19.683, 18.69, 18.755, 17.627, 16.978, 17.775, 18.652, 19.522, 20.718, 21.26, 20.735, 20.606, 19.472, 18.132, 17.291, 17.493, 17.821, 19.098, 17.274, 15.449, 14.374, 15.072, 15.695, 16.32, 16.961], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 23.267, 24.247, 22.063, 22.228, 25.077, 24.145, 23.686, 23.548, 22.757, 22.449, 21.47, 20.059, 20.02, 20.334, 21.216, 21.205, 21.629, 22.364, 22.848, 23.318, 23.569, 22.052, 21.576, 21.66, 22.527, 23.223, 23.333, 22.351, 20.786, 17.513, 18.394, 18.545, 19.17, 19.348], [nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 1754600000000.0, 1937500000000.0, 2073900000000.0, 2286500000000.0, 2498100000000.0, 2722600000000.0, 2898400000000.0, 3092100000000.0, 3346900000000.0, 3592800000000.0, 3825600000000.0, 3960200000000.0, 4215700000000.0, 4471000000000.0, 4741000000000.0, 4984200000000.0, 5268100000000.0, 5560700000000.0, 5903000000000.0, 6307000000000.0, 6792400000000.0, 7103100000000.0, 7384100000000.0, 7765500000000.0, 8260000000000.0, 8794100000000.0, 9304000000000.0, 9750500000000.0, 10013600000000.0, 9847000000000.0, 10202200000000.0, 10689300000000.0, 11083100000000.0, 11484300000000.0]]
    #test(7,8,a7,a8)



  a10=[[1060000000000.0, 970000000000.0, 900000000000.0, 790000000000.0, 780000000000.0, 860000000000.0, 940000000000.0, 1060000000000.0, 1110000000000.0, 1080000000000.0, 1160000000000.0, 1270000000000.0, 1490000000000.0, 1770000000000.0, 2069999999999.0, 2240000000000.0, 2220000000000.0, 1960000000000.0, 1960000000000.0, 2040000000000.0, 2000000000000.0, 2270000000000.0, 2400000000000.0, 2530000000000.0, 2540000000000.0, 2610000000000.0, 2780000000000.0, 2840000000000.0, 2850000000000.0, 2920000000000.0, 3060000000000.0, 3080000000000.0, 3280000000000.0, 3420000000000.0, 3600000000000.0, 3780000000000.0, 4099999999999.0, 4290000000000.0, 4400000000000.0, 4620000000000.0, 4720000000000.0, 4710000000000.0, 4910000000000.0, 5250000000000.0, 5460000000000.0, 5360000000000.0, 5490000000000.0, 5730000000000.0, 6020000000000.0, 6420000000000.0, 6500000000000.0, 6500000000000.0, 6590000000000.0, 6490000000000.0, 7000000000000.0, 7400000000000.0, 7710000000000.0, 7940000000000.0, 8289999999999.0, 8609999999999.0, 8850000000000.0, 8910000000000.0, 9020000000000.0, 9410000000000.0, 9650000000000.0, 10050000000000.0, 10280000000000.0, 10740000000000.0, 11210000000000.0, 11770000000000.0, 12320000000000.0, 12680000000000.0, 12710000000000.0, 12960000000000.0, 13530000000000.0, 13950000000000.0, 14370000000000.0, 14720000000000.0, 14990000000000.0, 14580000000000.0, 14540000000000.0, 14940000000000.0, 15190000000000.0, 15430000000000.0, 15920000000000.0, 16160000000000.0]]
  a11=[[24.9, 25.2, 23.3, 20.1, 22.7, 22.5, 17.9, 19.2, 20.0, 20.7, 14.4, 13.2, 17.8, 21.1, 17.5, 14.6, 18.7, 20.2, 18.8, 12.5, 14.6, 14.0, 17.5, 17.1, 13.3, 10.5, 11.9, 14.9, 10.0, 8.5]]
  a12=[[23.0, 26.7, 28.0, 22.8, 19.9, 21.1, 19.4, 15.8, 22.3, 15.8, 18.9, 15.9, 14.8, 13.9, 14.4, 17.1, 16.3, 16.4, 15.8, 15.4, 18.2, 11.1, 9.1, 10.7, 10.6, 15.8, 9.6, 9.3, 15.5, 11.7]]
  a13=[[26.9, 28.2, 25.6, 21.4, 25.6, 19.8, 21.1, 22.7, 17.8, 18.2, 16.6, 18.7, 20.8, 17.4, 20.6, 19.7, 13.9, 12.7, 12.8, 18.4, 11.1, 17.0, 13.3, 13.8, 16.5, 13.1, 14.7, 12.0, 12.7, 15.1]]
  a14=[[85.9, 84.7, 85.7, 84.6, 85.5, 86.1, nil, nil, 83.0, 82.8, 82.9, 83.0, 83.4, 82.9, 83.0, 82.1]]
  a15=[[0.076652, 0.069113, 0.060317, 0.079166, 0.065343, 0.05906, 0.050264, 0.06283, 0.071626, 0.082935, 0.079166, 0.075471, 0.198128, 1.08839, 0.485686, 0.212806, 0.501951, 0.197131, nil, 0.123237]]
  a16=[[0.03545, 0.03364, 0.03909, 0.05409, 0.06, 0.03182, 0.06591, 0.06864, 1.92045, 0.0985, 0.1175, 0.125, 0.115, 0.113, 0.1, 0.09, 0.114, 0.118, 0.103, 0.105, 0.107, 0.114, 0.113, 0.107, 0.108, 0.28]]
  a17=[[4.8208333333333, 4.5, 4.5, 4.5, 4.5, 4.535, 5.625, 5.6333333333333, 6.3125, 7.9516666666667, 7.91, 5.7233333333333, 5.2483333333333, 8.0216666666667, 10.798333333333, 7.8625, 6.84, 6.8241666666667, 9.0566666666667, 12.665833333333, 15.265833333333, 18.87, 14.860833333333, 10.794166666667, 12.0425, 9.9333333333333, 8.3325, 8.2033333333333, 9.315, 10.873333333333, 10.009166666667, 8.4633333333333, 6.2516666666667, 6.0, 7.1383333333333, 8.8291666666667, 8.2708333333333, 8.4416666666667, 8.3541666666667, 7.9941666666667, 9.2333333333333, 6.9216666666667, 4.675, 4.1225, 4.34, 6.1891666666667, 7.9575, 8.05, 5.0875, 3.25, 3.25, 3.25, 3.25, 3.25]]

  a20=[[180670000.0, 183690000.0, 186540000.0, 189240000.0, 191890000.0, 194300000.0, 196560000.0, 198710000.0, 200710000.0, 202680000.0, 205050000.0, 207660000.0, 209900000.0, 211910000.0, 213850000.0, 215970000.0, 218040000.0, 220240000.0, 222580000.0, 225060000.0, 227220000.0, 229470000.0, 231660000.0, 233790000.0, 235820000.0, 237920000.0, 240130000.0, 242290000.0, 244500000.0, 246820000.0, 249620000.0, 252980000.0, 256510000.0, 259920000.0, 263130000.0, 266279999.0, 269390000.0, 272650000.0, 275850000.0, 279040000.0, 282160000.0, 284970000.0, 287630000.0, 290110000.0, 292810000.0, 295520000.0, 298380000.0, 301230000.0, 304090000.0, 306770000.0, 309330000.0, 311590000.0, 313910000.0, 316160000.0]]
  a21=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, -11.375, 8.9, -65.875, -96.025, -63.3, -76.1, -98.15, -50.225, -20.4, 4.425, -42.8, -75.375, -140.625, -103.4, -20.325, 21.675, 91.7, 200.325, 302.0, 322.6, 397.9, 155.705, -214.143, -352.056, -327.619, -187.953, -53.232, -158.688, -730.209, -1669.565, -1381.167, -1182.383, -1022.657, -607.236]]
  a22=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 718.708, 799.421, 964.618, 1169.27, 1348.95, 1576.86, 1824.02, 2040.74, 2269.8, 2447.21, 2664.53, 2959.52, 3346.96, 3689.85, 3878.79, 4018.99, 4098.05, 4095.44, 3978.42, 3786.63, 3543.94, 3587.188, 3990.443, 4571.797, 5755.2, 6057.852, 6202.144, 6440.884, 7425.251, 8955.682, 10424.989, 11802.752, 12840.457, 13474.773]]
  a23=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 882.6, 1011.1, 1042.3, 1108.9, 1229.1, 1338.7, 1423.7, 1548.3, 1658.7, 1799.3, 1907.9, 2010.6, 2071.0, 2194.4, 2359.4, 2496.1, 2676.6, 2868.9, 3059.7, 3249.4, 3506.3, 3412.072, 3269.226, 3355.171, 3596.227, 4013.141, 4371.081, 4584.355, 4441.666, 4095.081, 4304.189, 4512.451, 4718.314, 5173.936]]
  a24=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 946.7, 1072.0, 1191.3, 1299.5, 1409.0, 1541.9, 1648.9, 1741.4, 1832.6, 1968.5, 2143.2, 2298.3, 2431.6, 2520.6, 2613.2, 2732.7, 2848.4, 2935.4, 3026.0, 3177.6, 3353.5, 3505.57, 3718.912, 3936.06, 4158.897, 4464.684, 4699.782, 5047.392, 5477.064, 6044.522, 5994.169, 6055.624, 6106.51, 6139.217]]
  a25=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 22.031, 23.21, 21.762, 19.776, 21.892, 20.336, 18.906, 19.551, 20.564, 19.683, 18.69, 18.755, 17.627, 16.978, 17.775, 18.652, 19.522, 20.718, 21.26, 20.735, 20.606, 19.472, 18.132, 17.291, 17.493, 17.821, 19.098, 17.274, 15.449, 14.374, 15.072, 15.695, 16.32, 16.961]]
  a26=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 23.267, 24.247, 22.063, 22.228, 25.077, 24.145, 23.686, 23.548, 22.757, 22.449, 21.47, 20.059, 20.02, 20.334, 21.216, 21.205, 21.629, 22.364, 22.848, 23.318, 23.569, 22.052, 21.576, 21.66, 22.527, 23.223, 23.333, 22.351, 20.786, 17.513, 18.394, 18.545, 19.17, 19.348]]
  a27=[[nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, 1754600000000.0, 1937500000000.0, 2073900000000.0, 2286500000000.0, 2498100000000.0, 2722600000000.0, 2898400000000.0, 3092100000000.0, 3346900000000.0, 3592800000000.0, 3825600000000.0, 3960200000000.0, 4215700000000.0, 4471000000000.0, 4741000000000.0, 4984200000000.0, 5268100000000.0, 5560700000000.0, 5903000000000.0, 6307000000000.0, 6792400000000.0, 7103100000000.0, 7384100000000.0, 7765500000000.0, 8260000000000.0, 8794100000000.0, 9304000000000.0, 9750500000000.0, 10013600000000.0, 9847000000000.0, 10202200000000.0, 10689300000000.0, 11083100000000.0, 11484300000000.0]]

  


  puts "\n"
  test(14,20,a14,a20)
  test(14,21,a14,a21)
  test(14,22,a14,a22)
  test(14,23,a14,a23)
  test(14,24,a14,a24)
  test(14,25,a14,a25)
  test(14,26,a14,a26)
  test(14,27,a14,a27)

  puts "\n"
  test(15,20,a15,a20)
  test(15,21,a15,a21)
  test(15,22,a15,a22)
  test(15,23,a15,a23)
  test(15,24,a15,a24)
  test(15,25,a15,a25)
  test(15,26,a15,a26)
  test(15,27,a15,a27)

  puts "\n"
  test(7,8,a7,a8)

  end
end